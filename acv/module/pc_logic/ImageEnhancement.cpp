#include <stdio.h>
#include <assert.h>
#include <malloc.h>
#include <float.h>
#include <math.h>
#include "ImageEnhancement.h"

#ifndef max
#define max(a,b)            (((a) > (b)) ? (a) : (b))
#endif

#ifndef min
#define min(a,b)            (((a) < (b)) ? (a) : (b))
#endif

#define  SCALE_NUM 3
static int gs_scale_radius[SCALE_NUM] = {4, 16, 40};
static float gs_scale_weight[SCALE_NUM] = {1/3.f, 1/3.f, 1/3.f};
static int gs_scale_weight_inverse[SCALE_NUM] = {3, 3, 3};

#define USE_FAST_LOG_APPROXI
#if (0)
#define USE_FAST_POW_APPROXI
#else
#define USE_EXP_LOOKUP_TABLE
#endif

/*************** Math tricks part begins************************************/
#define POW_SHIFT 11
#define LOG_SHIFT 11
#define EXP_SHIFT 10
/*approx_log10_int[i] = (int)(log10((i+1)/1024.f)*1024);*/
static int approx_log10_int[1<<LOG_SHIFT] = {-3082,-2774,-2593,-2466,-2366,-2285,-2217,-2157,-2105,-2058,-2016,-1977,-1941,-1908,-1878,-1849,-1822,-1797,-1773,-1750,-1728,-1707,-1688,-1669,-1651,-1633,-1616,-1600,-1585,-1569,-1555,-1541,-1527,-1514,-1501,-1488,-1476,-1464,-1453,-1442,-1431,-1420,-1409,-1399,-1389,-1379,-1370,-1360,-1351,-1342,-1333,-1325,-1316,-1308,-1300,-1292,-1284,-1276,-1269,-1261,-1254,-1247,-1240,-1233,-1226,-1219,-1212,-1206,-1199,-1193,-1186,-1180,-1174,-1168,-1162,-1156,-1150,-1145,-1139,-1133,-1128,-1122,-1117,-1112,-1106,-1101,-1096,-1091,-1086,-1081,-1076,-1071,-1066,-1062,-1057,-1052,-1048,-1043,-1039,-1034,-1030,-1025,-1021,-1017,-1012,-1008,-1004,-1000,-996,-992,-988,-984,-980,-976,-972,-968,-964,-960,-957,-953,-949,-946,-942,-938,-935,-931,-928,-924,-921,-917,-914,-911,-907,-904,-901,-897,-894,-891,-888,-884,-881,-878,-875,-872,-869,-866,-863,-860,-857,-854,-851,-848,-845,-842,-839,-836,-833,-831,-828,-825,-822,-820,-817,-814,-811,-809,-806,-803,-801,-798,-795,-793,-790,-788,-785,-783,-780,-778,-775,-773,-770,-768,-765,-763,-760,-758,-756,-753,-751,-749,-746,-744,-742,-739,-737,-735,-733,-730,-728,-726,-724,-721,-719,-717,-715,-713,-710,-708,-706,-704,-702,-700,-698,-696,-694,-692,-690,-687,-685,-683,-681,-679,-677,-675,-673,-671,-669,-668,-666,-664,-662,-660,-658,-656,-654,-652,-650,-648,-647,-645,-643,-641,-639,-637,-636,-634,-632,-630,-628,-627,-625,-623,-621,-619,-618,-616,-614,-613,-611,-609,-607,-606,-604,-602,-601,-599,-597,-596,-594,-592,-591,-589,-587,-586,-584,-583,-581,-579,-578,-576,-575,-573,-571,-570,-568,-567,-565,-564,-562,-561,-559,-557,-556,-554,-553,-551,-550,-548,-547,-545,-544,-543,-541,-540,-538,-537,-535,-534,-532,-531,-529,-528,-527,-525,-524,-522,-521,-520,-518,-517,-515,-514,-513,-511,-510,-509,-507,-506,-504,-503,-502,-500,-499,-498,-496,-495,-494,-492,-491,-490,-489,-487,-486,-485,-483,-482,-481,-479,-478,-477,-476,-474,-473,-472,-471,-469,-468,-467,-466,-464,-463,-462,-461,-459,-458,-457,-456,-455,-453,-452,-451,-450,-449,-447,-446,-445,-444,-443,-442,-440,-439,-438,-437,-436,-435,-433,-432,-431,-430,-429,-428,-427,-425,-424,-423,-422,-421,-420,-419,-418,-416,-415,-414,-413,-412,-411,-410,-409,-408,-407,-405,-404,-403,-402,-401,-400,-399,-398,-397,-396,-395,-394,-393,-392,-391,-390,-388,-387,-386,-385,-384,-383,-382,-381,-380,-379,-378,-377,-376,-375,-374,-373,-372,-371,-370,-369,-368,-367,-366,-365,-364,-363,-362,-361,-360,-359,-358,-357,-356,-355,-354,-353,-352,-352,-351,-350,-349,-348,-347,-346,-345,-344,-343,-342,-341,-340,-339,-338,-337,-336,-336,-335,-334,-333,-332,-331,-330,-329,-328,-327,-326,-325,-325,-324,-323,-322,-321,-320,-319,-318,-317,-317,-316,-315,-314,-313,-312,-311,-310,-309,-309,-308,-307,-306,-305,-304,-303,-303,-302,-301,-300,-299,-298,-297,-297,-296,-295,-294,-293,-292,-292,-291,-290,-289,-288,-287,-287,-286,-285,-284,-283,-282,-282,-281,-280,-279,-278,-278,-277,-276,-275,-274,-273,-273,-272,-271,-270,-269,-269,-268,-267,-266,-266,-265,-264,-263,-262,-262,-261,-260,-259,-258,-258,-257,-256,-255,-255,-254,-253,-252,-252,-251,-250,-249,-248,-248,-247,-246,-245,-245,-244,-243,-242,-242,-241,-240,-239,-239,-238,-237,-236,-236,-235,-234,-234,-233,-232,-231,-231,-230,-229,-228,-228,-227,-226,-226,-225,-224,-223,-223,-222,-221,-220,-220,-219,-218,-218,-217,-216,-216,-215,-214,-213,-213,-212,-211,-211,-210,-209,-209,-208,-207,-206,-206,-205,-204,-204,-203,-202,-202,-201,-200,-200,-199,-198,-198,-197,-196,-196,-195,-194,-193,-193,-192,-191,-191,-190,-189,-189,-188,-187,-187,-186,-185,-185,-184,-184,-183,-182,-182,-181,-180,-180,-179,-178,-178,-177,-176,-176,-175,-174,-174,-173,-172,-172,-171,-171,-170,-169,-169,-168,-167,-167,-166,-166,-165,-164,-164,-163,-162,-162,-161,-160,-160,-159,-159,-158,-157,-157,-156,-156,-155,-154,-154,-153,-152,-152,-151,-151,-150,-149,-149,-148,-148,-147,-146,-146,-145,-145,-144,-143,-143,-142,-142,-141,-140,-140,-139,-139,-138,-137,-137,-136,-136,-135,-134,-134,-133,-133,-132,-132,-131,-130,-130,-129,-129,-128,-127,-127,-126,-126,-125,-125,-124,-123,-123,-122,-122,-121,-121,-120,-119,-119,-118,-118,-117,-117,-116,-115,-115,-114,-114,-113,-113,-112,-112,-111,-110,-110,-109,-109,-108,-108,-107,-107,-106,-105,-105,-104,-104,-103,-103,-102,-102,-101,-100,-100,-99,-99,-98,-98,-97,-97,-96,-96,-95,-95,-94,-93,-93,-92,-92,-91,-91,-90,-90,-89,-89,-88,-88,-87,-87,-86,-85,-85,-84,-84,-83,-83,-82,-82,-81,-81,-80,-80,-79,-79,-78,-78,-77,-77,-76,-76,-75,-75,-74,-74,-73,-72,-72,-71,-71,-70,-70,-69,-69,-68,-68,-67,-67,-66,-66,-65,-65,-64,-64,-63,-63,-62,-62,-61,-61,-60,-60,-59,-59,-58,-58,-57,-57,-56,-56,-55,-55,-54,-54,-53,-53,-52,-52,-52,-51,-51,-50,-50,-49,-49,-48,-48,-47,-47,-46,-46,-45,-45,-44,-44,-43,-43,-42,-42,-41,-41,-40,-40,-39,-39,-39,-38,-38,-37,-37,-36,-36,-35,-35,-34,-34,-33,-33,-32,-32,-31,-31,-31,-30,-30,-29,-29,-28,-28,-27,-27,-26,-26,-25,-25,-25,-24,-24,-23,-23,-22,-22,-21,-21,-20,-20,-19,-19,-19,-18,-18,-17,-17,-16,-16,-15,-15,-15,-14,-14,-13,-13,-12,-12,-11,-11,-10,-10,-10,-9,-9,-8,-8,-7,-7,-7,-6,-6,-5,-5,-4,-4,-3,-3,-3,-2,-2,-1,-1,0,0,0,0,0,1,1,2,2,3,3,3,4,4,5,5,6,6,6,7,7,8,8,9,9,9,10,10,11,11,11,12,12,13,13,14,14,14,15,15,16,16,17,17,17,18,18,19,19,19,20,20,21,21,22,22,22,23,23,24,24,24,25,25,26,26,26,27,27,28,28,28,29,29,30,30,31,31,31,32,32,33,33,33,34,34,35,35,35,36,36,37,37,37,38,38,39,39,39,40,40,41,41,41,42,42,43,43,43,44,44,44,45,45,46,46,46,47,47,48,48,48,49,49,50,50,50,51,51,51,52,52,53,53,53,54,54,55,55,55,56,56,56,57,57,58,58,58,59,59,60,60,60,61,61,61,62,62,63,63,63,64,64,64,65,65,66,66,66,67,67,67,68,68,69,69,69,70,70,70,71,71,72,72,72,73,73,73,74,74,74,75,75,76,76,76,77,77,77,78,78,78,79,79,80,80,80,81,81,81,82,82,82,83,83,84,84,84,85,85,85,86,86,86,87,87,87,88,88,89,89,89,90,90,90,91,91,91,92,92,92,93,93,93,94,94,95,95,95,96,96,96,97,97,97,98,98,98,99,99,99,100,100,100,101,101,102,102,102,103,103,103,104,104,104,105,105,105,106,106,106,107,107,107,108,108,108,109,109,109,110,110,110,111,111,111,112,112,112,113,113,113,114,114,114,115,115,115,116,116,116,117,117,117,118,118,118,119,119,119,120,120,120,121,121,121,122,122,122,123,123,123,124,124,124,125,125,125,126,126,126,127,127,127,128,128,128,129,129,129,130,130,130,131,131,131,132,132,132,133,133,133,133,134,134,134,135,135,135,136,136,136,137,137,137,138,138,138,139,139,139,140,140,140,140,141,141,141,142,142,142,143,143,143,144,144,144,145,145,145,146,146,146,146,147,147,147,148,148,148,149,149,149,150,150,150,150,151,151,151,152,152,152,153,153,153,154,154,154,155,155,155,155,156,156,156,157,157,157,158,158,158,158,159,159,159,160,160,160,161,161,161,161,162,162,162,163,163,163,164,164,164,165,165,165,165,166,166,166,167,167,167,167,168,168,168,169,169,169,170,170,170,170,171,171,171,172,172,172,173,173,173,173,174,174,174,175,175,175,175,176,176,176,177,177,177,177,178,178,178,179,179,179,180,180,180,180,181,181,181,182,182,182,182,183,183,183,184,184,184,184,185,185,185,186,186,186,186,187,187,187,188,188,188,188,189,189,189,190,190,190,190,191,191,191,192,192,192,192,193,193,193,194,194,194,194,195,195,195,195,196,196,196,197,197,197,197,198,198,198,199,199,199,199,200,200,200,200,201,201,201,202,202,202,202,203,203,203,203,204,204,204,205,205,205,205,206,206,206,207,207,207,207,208,208,208,208,209,209,209,209,210,210,210,211,211,211,211,212,212,212,212,213,213,213,214,214,214,214,215,215,215,215,216,216,216,216,217,217,217,218,218,218,218,219,219,219,219,220,220,220,220,221,221,221,222,222,222,222,223,223,223,223,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,228,228,228,228,229,229,229,229,230,230,230,230,231,231,231,231,232,232,232,232,233,233,233,233,234,234,234,235,235,235,235,236,236,236,236,237,237,237,237,238,238,238,238,239,239,239,239,240,240,240,240,241,241,241,241,242,242,242,242,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,250,250,250,250,251,251,251,251,252,252,252,252,253,253,253,253,254,254,254,254,255,255,255,255,256,256,256,256,256,257,257,257,257,258,258,258,258,259,259,259,259,260,260,260,260,261,261,261,261,262,262,262,262,263,263,263,263,263,264,264,264,264,265,265,265,265,266,266,266,266,267,267,267,267,268,268,268,268,269,269,269,269,269,270,270,270,270,271,271,271,271,272,272,272,272,273,273,273,273,273,274,274,274,274,275,275,275,275,276,276,276,276,276,277,277,277,277,278,278,278,278,279,279,279,279,280,280,280,280,280,281,281,281,281,282,282,282,282,283,283,283,283,283,284,284,284,284,285,285,285,285,285,286,286,286,286,287,287,287,287,288,288,288,288,288,289,289,289,289,290,290,290,290,290,291,291,291,291,292,292,292,292,293,293,293,293,293,294,294,294,294,295,295,295,295,295,296,296,296,296,297,297,297,297,297,298,298,298,298,299,299,299,299,299,300,300,300,300,301,301,301,301,301,302,302,302,302,303,303,303,303,303,304,304,304,304,304,305,305,305,305,306,306,306,306,306,307,307,307,307,308,308};
/*appox_exp_int[i] = expf((i-4*128)/128.f) * (1<<10); 
  range: [-4, 4) */
static int approx_exp[4*2*(1<<7)] = {18,18,19,19,19,19,19,19,19,20,20,20,20,20,20,21,21,21,21,21,21,22,22,22,22,22,22,23,23,23,23,23,24,24,24,24,24,25,25,25,25,25,26,26,26,26,26,27,27,27,27,27,28,28,28,28,29,29,29,29,29,30,30,30,30,31,31,31,31,32,32,32,32,33,33,33,33,34,34,34,35,35,35,35,36,36,36,37,37,37,37,38,38,38,39,39,39,40,40,40,40,41,41,41,42,42,42,43,43,43,44,44,44,45,45,46,46,46,47,47,47,48,48,49,49,49,50,50,50,51,51,52,52,53,53,53,54,54,55,55,55,56,56,57,57,58,58,59,59,60,60,61,61,61,62,62,63,63,64,64,65,65,66,67,67,68,68,69,69,70,70,71,71,72,73,73,74,74,75,75,76,77,77,78,78,79,80,80,81,82,82,83,84,84,85,86,86,87,88,88,89,90,90,91,92,93,93,94,95,95,96,97,98,99,99,100,101,102,102,103,104,105,106,107,107,108,109,110,111,112,113,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,144,145,146,147,148,149,151,152,153,154,155,157,158,159,160,162,163,164,165,167,168,169,171,172,173,175,176,177,179,180,182,183,185,186,187,189,190,192,193,195,196,198,200,201,203,204,206,208,209,211,212,214,216,218,219,221,223,224,226,228,230,232,233,235,237,239,241,243,245,247,248,250,252,254,256,258,260,262,265,267,269,271,273,275,277,279,282,284,286,288,291,293,295,298,300,302,305,307,309,312,314,317,319,322,324,327,329,332,335,337,340,342,345,348,351,353,356,359,362,365,367,370,373,376,379,382,385,388,391,394,397,401,404,407,410,413,416,420,423,426,430,433,436,440,443,447,450,454,457,461,465,468,472,476,479,483,487,491,495,499,502,506,510,514,518,523,527,531,535,539,543,548,552,556,561,565,569,574,578,583,588,592,597,601,606,611,616,621,625,630,635,640,645,650,655,661,666,671,676,682,687,692,698,703,709,714,720,726,731,737,743,749,755,760,766,772,779,785,791,797,803,810,816,822,829,835,842,848,855,862,869,875,882,889,896,903,910,917,925,932,939,947,954,961,969,977,984,992,1000,1008,1016,1024,1032,1040,1048,1056,1064,1073,1081,1090,1098,1107,1115,1124,1133,1142,1151,1160,1169,1178,1187,1197,1206,1216,1225,1235,1244,1254,1264,1274,1284,1294,1304,1314,1325,1335,1346,1356,1367,1377,1388,1399,1410,1421,1432,1444,1455,1466,1478,1489,1501,1513,1525,1537,1549,1561,1573,1586,1598,1610,1623,1636,1649,1662,1675,1688,1701,1714,1728,1741,1755,1769,1783,1797,1811,1825,1839,1854,1868,1883,1898,1913,1928,1943,1958,1973,1989,2004,2020,2036,2052,2068,2084,2101,2117,2134,2150,2167,2184,2201,2219,2236,2254,2271,2289,2307,2325,2343,2362,2380,2399,2418,2437,2456,2475,2495,2514,2534,2554,2574,2594,2614,2635,2656,2676,2697,2719,2740,2761,2783,2805,2827,2849,2871,2894,2917,2939,2963,2986,3009,3033,3057,3081,3105,3129,3154,3178,3203,3228,3254,3279,3305,3331,3357,3383,3410,3437,3464,3491,3518,3546,3574,3602,3630,3658,3687,3716,3745,3775,3804,3834,3864,3894,3925,3956,3987,4018,4049,4081,4113,4146,4178,4211,4244,4277,4311,4345,4379,4413,4448,4482,4518,4553,4589,4625,4661,4698,4734,4772,4809,4847,4885,4923,4962,5001,5040,5079,5119,5159,5200,5241,5282,5323,5365,5407,5449,5492,5535,5579,5622,5666,5711,5756,5801,5846,5892,5938,5985,6032,6079,6127,6175,6223,6272,6321,6371,6421,6471,6522,6573,6625,6677,6729,6782,6835,6889,6943,6997,7052,7107,7163,7219,7276,7333,7391,7449,7507,7566,7625,7685,7745,7806,7867,7929,7991,8054,8117,8181,8245,8310,8375,8440,8507,8573,8641,8708,8777,8846,8915,8985,9055,9126,9198,9270,9343,9416,9490,9564,9639,9715,9791,9868,9945,10023,10102,10181,10261,10342,10423,10504,10587,10670,10754,10838,10923,11009,11095,11182,11270,11358,11447,11537,11627,11719,11810,11903,11996,12091,12185,12281,12377,12474,12572,12671,12770,12870,12971,13073,13176,13279,13383,13488,13594,13700,13808,13916,14025,14135,14246,14358,14471,14584,14698,14814,14930,15047,15165,15284,15404,15525,15646,15769,15893,16018,16143,16270,16397,16526,16656,16786,16918,17051,17184,17319,17455,17592,17730,17869,18009,18150,18293,18436,18581,18727,18873,19021,19171,19321,19473,19625,19779,19934,20091,20248,20407,20567,20728,20891,21055,21220,21386,21554,21723,21894,22065,22238,22413,22589,22766,22944,23124,23306,23488,23673,23858,24045,24234,24424,24616,24809,25003,25199,25397,25596,25797,25999,26203,26409,26616,26825,27035,27247,27461,27676,27893,28112,28333,28555,28779,29004,29232,29461,29692,29925,30160,30396,30635,30875,31117,31361,31607,31855,32105,32357,32611,32866,33124,33384,33646,33910,34176,34444,34714,34986,35261,35537,35816,36097,36380,36665,36953,37243,37535,37829,38126,38425,38726,39030,39336,39645,39956,40269,40585,40903,41224,41547,41873,42201,42532,42866,43202,43541,43883,44227,44574,44923,45276,45631,45989,46349,46713,47079,47448,47821,48196,48574,48955,49339,49726,50116,50509,50905,51304,51706,52112,52521,52933,53348,53766,54188,54613,55041,55473};
static const float _2p23 = 8388608.0f;
static unsigned int pow_table_11[1<<POW_SHIFT] = {1420,4260,7101,9943,12786,15630,18475,21321,24167,27015,29864,32714,35564,38416,41269,44122,46977,49832,52689,55546,58405,61264,64124,66986,69848,72711,75575,78441,81307,84174,87042,89911,92781,95652,98524,101397,104271,107146,110022,112899,115776,118655,121535,124416,127298,130180,133064,135949,138834,141721,144608,147497,150386,153277,156169,159061,161954,164849,167744,170641,173538,176436,179336,182236,185137,188040,190943,193847,196752,199659,202566,205474,208383,211293,214204,217117,220030,222944,225859,228775,231692,234610,237529,240449,243370,246292,249215,252139,255064,257990,260917,263845,266774,269704,272635,275566,278499,281433,284368,287304,290241,293179,296118,299057,301998,304940,307883,310827,313772,316717,319664,322612,325561,328511,331462,334413,337366,340320,343275,346231,349187,352145,355104,358064,361025,363986,366949,369913,372878,375844,378811,381778,384747,387717,390688,393660,396633,399607,402582,405557,408534,411512,414491,417471,420452,423434,426417,429401,432386,435372,438359,441347,444336,447326,450317,453309,456302,459296,462291,465287,468284,471282,474282,477282,480283,483285,486288,489293,492298,495304,498311,501320,504329,507339,510351,513363,516376,519391,522406,525423,528440,531459,534478,537499,540520,543543,546566,549591,552617,555643,558671,561700,564730,567760,570792,573825,576859,579894,582930,585967,589004,592043,595083,598125,601167,604210,607254,610299,613345,616392,619441,622490,625540,628592,631644,634698,637752,640808,643864,646922,649980,653040,656101,659162,662225,665289,668354,671419,674486,677554,680623,683693,686764,689836,692909,695984,699059,702135,705212,708291,711370,714451,717532,720614,723698,726783,729868,732955,736043,739131,742221,745312,748404,751497,754591,757686,760782,763879,766977,770077,773177,776278,779381,782484,785589,788694,791801,794908,798017,801127,804238,807349,810462,813576,816691,819807,822925,826043,829162,832282,835404,838526,841649,844774,847900,851026,854154,857283,860412,863543,866675,869808,872942,876077,879214,882351,885489,888628,891769,894910,898053,901196,904341,907487,910634,913782,916930,920080,923232,926384,929537,932691,935846,939003,942160,945319,948478,951639,954801,957964,961128,964293,967459,970626,973794,976963,980133,983305,986477,989651,992825,996001,999178,1002356,1005535,1008715,1011896,1015078,1018261,1021445,1024631,1027817,1031005,1034193,1037383,1040574,1043766,1046959,1050153,1053348,1056544,1059741,1062940,1066139,1069340,1072541,1075744,1078948,1082152,1085358,1088565,1091773,1094983,1098193,1101404,1104617,1107830,1111045,1114261,1117477,1120695,1123914,1127134,1130355,1133578,1136801,1140025,1143251,1146478,1149705,1152934,1156164,1159395,1162627,1165860,1169094,1172330,1175566,1178804,1182042,1185282,1188523,1191765,1195008,1198252,1201497,1204744,1207991,1211240,1214489,1217740,1220992,1224245,1227499,1230754,1234010,1237267,1240526,1243785,1247046,1250308,1253571,1256835,1260100,1263366,1266633,1269902,1273171,1276442,1279713,1282986,1286260,1289535,1292811,1296088,1299367,1302646,1305927,1309208,1312491,1315775,1319060,1322346,1325633,1328922,1332211,1335502,1338794,1342086,1345380,1348675,1351971,1355269,1358567,1361867,1365167,1368469,1371772,1375076,1378381,1381687,1384994,1388303,1391612,1394923,1398235,1401548,1404862,1408177,1411493,1414811,1418129,1421449,1424770,1428092,1431415,1434739,1438064,1441390,1444718,1448047,1451376,1454707,1458039,1461373,1464707,1468042,1471379,1474717,1478055,1481395,1484736,1488079,1491422,1494766,1498112,1501459,1504807,1508156,1511506,1514857,1518209,1521563,1524918,1528273,1531630,1534988,1538348,1541708,1545070,1548432,1551796,1555161,1558527,1561894,1565262,1568632,1572002,1575374,1578747,1582121,1585496,1588873,1592250,1595629,1599008,1602389,1605771,1609155,1612539,1615924,1619311,1622699,1626088,1629478,1632869,1636261,1639655,1643049,1646445,1649842,1653240,1656639,1660040,1663441,1666844,1670248,1673653,1677059,1680466,1683875,1687284,1690695,1694107,1697520,1700934,1704350,1707766,1711184,1714603,1718023,1721444,1724867,1728290,1731715,1735140,1738567,1741996,1745425,1748855,1752287,1755720,1759154,1762589,1766025,1769462,1772901,1776341,1779782,1783224,1786667,1790111,1793557,1797004,1800452,1803901,1807351,1810802,1814255,1817709,1821164,1824620,1828077,1831535,1834995,1838456,1841918,1845381,1848845,1852311,1855777,1859245,1862714,1866184,1869656,1873128,1876602,1880077,1883553,1887030,1890508,1893988,1897469,1900950,1904434,1907918,1911403,1914890,1918378,1921867,1925357,1928848,1932341,1935835,1939329,1942826,1946323,1949821,1953321,1956822,1960324,1963827,1967331,1970837,1974344,1977852,1981361,1984871,1988383,1991895,1995409,1998924,2002440,2005958,2009477,2012996,2016517,2020040,2023563,2027088,2030613,2034140,2037669,2041198,2044729,2048260,2051793,2055327,2058863,2062399,2065937,2069476,2073016,2076558,2080100,2083644,2087189,2090735,2094282,2097831,2101381,2104931,2108484,2112037,2115592,2119147,2122704,2126262,2129822,2133382,2136944,2140507,2144071,2147637,2151203,2154771,2158340,2161910,2165482,2169054,2172628,2176203,2179780,2183357,2186936,2190516,2194097,2197679,2201263,2204847,2208433,2212021,2215609,2219199,2222789,2226382,2229975,2233569,2237165,2240762,2244360,2247959,2251560,2255162,2258765,2262369,2265974,2269581,2273189,2276798,2280408,2284020,2287633,2291247,2294862,2298478,2302096,2305715,2309335,2312956,2316579,2320203,2323828,2327454,2331081,2334710,2338340,2341971,2345604,2349237,2352872,2356508,2360145,2363784,2367424,2371065,2374707,2378350,2381995,2385641,2389288,2392937,2396586,2400237,2403889,2407543,2411197,2414853,2418510,2422168,2425828,2429489,2433151,2436814,2440478,2444144,2447811,2451479,2455149,2458820,2462491,2466165,2469839,2473515,2477192,2480870,2484549,2488230,2491912,2495595,2499279,2502965,2506652,2510340,2514029,2517720,2521412,2525105,2528799,2532495,2536192,2539890,2543589,2547290,2550992,2554695,2558399,2562105,2565812,2569520,2573230,2576940,2580652,2584365,2588080,2591795,2595512,2599231,2602950,2606671,2610393,2614116,2617841,2621566,2625293,2629022,2632751,2636482,2640214,2643948,2647682,2651418,2655155,2658894,2662633,2666374,2670116,2673860,2677605,2681351,2685098,2688846,2692596,2696347,2700100,2703853,2707608,2711364,2715122,2718880,2722640,2726402,2730164,2733928,2737693,2741459,2745227,2748996,2752766,2756537,2760310,2764084,2767859,2771636,2775414,2779193,2782973,2786755,2790538,2794322,2798108,2801894,2805683,2809472,2813263,2817054,2820848,2824642,2828438,2832235,2836033,2839833,2843634,2847436,2851240,2855044,2858850,2862658,2866466,2870276,2874088,2877900,2881714,2885529,2889345,2893163,2896982,2900802,2904624,2908447,2912271,2916096,2919923,2923751,2927580,2931411,2935243,2939076,2942911,2946746,2950584,2954422,2958262,2962103,2965945,2969789,2973634,2977480,2981327,2985176,2989026,2992878,2996730,3000584,3004440,3008296,3012154,3016014,3019874,3023736,3027599,3031464,3035329,3039196,3043065,3046935,3050806,3054678,3058552,3062427,3066303,3070180,3074059,3077939,3081821,3085704,3089588,3093473,3097360,3101248,3105138,3109028,3112920,3116814,3120709,3124605,3128502,3132400,3136300,3140202,3144104,3148008,3151913,3155820,3159728,3163637,3167548,3171459,3175373,3179287,3183203,3187120,3191039,3194958,3198880,3202802,3206726,3210651,3214577,3218505,3222434,3226365,3230296,3234230,3238164,3242100,3246037,3249975,3253915,3257856,3261798,3265742,3269687,3273634,3277582,3281531,3285481,3289433,3293386,3297340,3301296,3305253,3309212,3313172,3317133,3321095,3325059,3329024,3332991,3336959,3340928,3344898,3348870,3352843,3356818,3360794,3364771,3368750,3372730,3376711,3380694,3384678,3388663,3392650,3396638,3400627,3404618,3408610,3412604,3416598,3420594,3424592,3428591,3432591,3436593,3440596,3444600,3448605,3452612,3456621,3460631,3464642,3468654,3472668,3476683,3480699,3484717,3488737,3492757,3496779,3500802,3504827,3508853,3512880,3516909,3520939,3524971,3529004,3533038,3537073,3541110,3545149,3549188,3553229,3557272,3561316,3565361,3569407,3573455,3577504,3581555,3585607,3589660,3593715,3597771,3601829,3605887,3609948,3614009,3618072,3622137,3626202,3630270,3634338,3638408,3642479,3646552,3650626,3654701,3658778,3662856,3666936,3671016,3675099,3679182,3683267,3687354,3691442,3695531,3699621,3703713,3707807,3711901,3715998,3720095,3724194,3728294,3732396,3736499,3740603,3744709,3748816,3752925,3757035,3761147,3765259,3769373,3773489,3777606,3781724,3785844,3789965,3794088,3798212,3802337,3806464,3810592,3814722,3818852,3822985,3827118,3831254,3835390,3839528,3843667,3847808,3851950,3856094,3860239,3864385,3868533,3872682,3876832,3880984,3885138,3889292,3893449,3897606,3901765,3905926,3910087,3914251,3918415,3922581,3926749,3930918,3935088,3939259,3943433,3947607,3951783,3955960,3960139,3964319,3968501,3972684,3976868,3981054,3985241,3989430,3993620,3997811,4002004,4006199,4010394,4014591,4018790,4022990,4027191,4031394,4035599,4039804,4044011,4048220,4052430,4056641,4060854,4065068,4069284,4073501,4077720,4081940,4086161,4090384,4094608,4098834,4103061,4107289,4111519,4115751,4119984,4124218,4128453,4132691,4136929,4141169,4145411,4149653,4153898,4158144,4162391,4166639,4170889,4175141,4179394,4183648,4187904,4192161,4196420,4200680,4204942,4209205,4213469,4217735,4222002,4226271,4230541,4234813,4239086,4243361,4247637,4251914,4256193,4260474,4264755,4269039,4273323,4277609,4281897,4286186,4290477,4294769,4299062,4303357,4307653,4311951,4316250,4320551,4324853,4329157,4333462,4337768,4342076,4346386,4350697,4355009,4359323,4363638,4367955,4372273,4376593,4380914,4385236,4389561,4393886,4398213,4402541,4406871,4411203,4415536,4419870,4424206,4428543,4432882,4437222,4441563,4445907,4450251,4454597,4458945,4463294,4467644,4471996,4476350,4480704,4485061,4489419,4493778,4498139,4502501,4506865,4511230,4515597,4519965,4524335,4528706,4533078,4537452,4541828,4546205,4550584,4554964,4559345,4563728,4568113,4572498,4576886,4581275,4585665,4590057,4594451,4598845,4603242,4607640,4612039,4616440,4620842,4625246,4629651,4634058,4638466,4642876,4647287,4651700,4656114,4660530,4664947,4669366,4673786,4678208,4682631,4687056,4691482,4695910,4700339,4704770,4709202,4713636,4718071,4722508,4726946,4731386,4735827,4740269,4744714,4749159,4753607,4758055,4762506,4766957,4771411,4775865,4780322,4784780,4789239,4793700,4798162,4802626,4807091,4811558,4816026,4820496,4824968,4829441,4833915,4838391,4842868,4847347,4851828,4856310,4860793,4865278,4869765,4874253,4878742,4883234,4887726,4892220,4896716,4901213,4905712,4910212,4914714,4919217,4923722,4928228,4932736,4937246,4941756,4946269,4950783,4955298,4959815,4964334,4968854,4973376,4977899,4982423,4986950,4991477,4996007,5000537,5005070,5009604,5014139,5018676,5023214,5027754,5032296,5036839,5041384,5045930,5050478,5055027,5059578,5064130,5068684,5073239,5077796,5082355,5086915,5091476,5096039,5100604,5105170,5109738,5114307,5118878,5123450,5128024,5132600,5137177,5141756,5146336,5150917,5155501,5160085,5164672,5169260,5173849,5178440,5183033,5187627,5192222,5196820,5201418,5206019,5210621,5215224,5219829,5224436,5229044,5233653,5238265,5242877,5247492,5252108,5256725,5261344,5265965,5270587,5275211,5279836,5284463,5289092,5293722,5298353,5302986,5307621,5312257,5316895,5321535,5326176,5330818,5335462,5340108,5344755,5349404,5354055,5358707,5363360,5368015,5372672,5377330,5381990,5386652,5391315,5395979,5400645,5405313,5409983,5414654,5419326,5424000,5428676,5433353,5438032,5442712,5447394,5452078,5456763,5461450,5466138,5470828,5475520,5480213,5484908,5489604,5494302,5499001,5503702,5508405,5513109,5517815,5522522,5527232,5531942,5536654,5541368,5546084,5550801,5555519,5560239,5564961,5569685,5574410,5579136,5583864,5588594,5593326,5598059,5602793,5607529,5612267,5617007,5621748,5626490,5631234,5635980,5640728,5645477,5650227,5654980,5659733,5664489,5669246,5674005,5678765,5683527,5688291,5693056,5697822,5702591,5707361,5712132,5716906,5721680,5726457,5731235,5736015,5740796,5745579,5750363,5755150,5759937,5764727,5769518,5774310,5779105,5783900,5788698,5793497,5798298,5803100,5807904,5812710,5817517,5822326,5827137,5831949,5836762,5841578,5846395,5851214,5856034,5860856,5865679,5870505,5875331,5880160,5884990,5889822,5894655,5899490,5904327,5909165,5914005,5918846,5923690,5928534,5933381,5938229,5943079,5947930,5952783,5957638,5962494,5967352,5972212,5977073,5981936,5986800,5991667,5996534,6001404,6006275,6011148,6016022,6020898,6025776,6030655,6035537,6040419,6045304,6050190,6055077,6059967,6064857,6069750,6074644,6079540,6084438,6089337,6094238,6099141,6104045,6108951,6113858,6118767,6123678,6128591,6133505,6138421,6143338,6148258,6153178,6158101,6163025,6167951,6172878,6177808,6182738,6187671,6192605,6197541,6202479,6207418,6212359,6217301,6222245,6227191,6232139,6237088,6242039,6246992,6251946,6256902,6261859,6266819,6271780,6276742,6281707,6286673,6291640,6296610,6301581,6306554,6311528,6316504,6321482,6326461,6331443,6336425,6341410,6346396,6351384,6356374,6361365,6366358,6371353,6376349,6381347,6386347,6391348,6396351,6401356,6406363,6411371,6416381,6421393,6426406,6431421,6436438,6441456,6446476,6451498,6456521,6461547,6466573,6471602,6476632,6481664,6486698,6491733,6496771,6501809,6506850,6511892,6516936,6521982,6527029,6532078,6537129,6542181,6547236,6552292,6557349,6562408,6567469,6572532,6577597,6582663,6587731,6592800,6597872,6602945,6608020,6613096,6618174,6623254,6628336,6633419,6638504,6643591,6648680,6653770,6658862,6663955,6669051,6674148,6679247,6684347,6689450,6694554,6699660,6704767,6709876,6714987,6720100,6725214,6730330,6735448,6740568,6745689,6750812,6755937,6761064,6766192,6771322,6776454,6781587,6786723,6791860,6796998,6802139,6807281,6812425,6817571,6822718,6827867,6833018,6838171,6843325,6848481,6853639,6858799,6863960,6869123,6874288,6879455,6884623,6889793,6894965,6900139,6905314,6910491,6915670,6920851,6926033,6931217,6936403,6941591,6946780,6951971,6957164,6962359,6967555,6972753,6977953,6983155,6988358,6993564,6998771,7003979,7009190,7014402,7019616,7024832,7030050,7035269,7040490,7045713,7050938,7056164,7061392,7066622,7071854,7077087,7082323,7087560,7092798,7098039,7103281,7108525,7113771,7119019,7124269,7129520,7134773,7140028,7145284,7150542,7155803,7161064,7166328,7171594,7176861,7182130,7187401,7192673,7197948,7203224,7208502,7213782,7219063,7224347,7229632,7234919,7240207,7245498,7250790,7256084,7261380,7266678,7271977,7277278,7282581,7287886,7293193,7298501,7303811,7309123,7314437,7319753,7325070,7330389,7335710,7341033,7346358,7351684,7357012,7362342,7367674,7373008,7378343,7383681,7389020,7394360,7399703,7405048,7410394,7415742,7421092,7426444,7431797,7437152,7442510,7447869,7453229,7458592,7463956,7469322,7474691,7480060,7485432,7490806,7496181,7501558,7506937,7512318,7517700,7523085,7528471,7533859,7539249,7544641,7550034,7555429,7560827,7566226,7571627,7577029,7582434,7587840,7593248,7598658,7604070,7609484,7614899,7620316,7625736,7631157,7636579,7642004,7647431,7652859,7658289,7663721,7669155,7674591,7680028,7685467,7690909,7696352,7701797,7707243,7712692,7718142,7723595,7729049,7734505,7739962,7745422,7750884,7756347,7761812,7767279,7772748,7778219,7783691,7789166,7794642,7800120,7805600,7811082,7816566,7822052,7827539,7833028,7838519,7844012,7849507,7855004,7860503,7866003,7871505,7877010,7882516,7888024,7893533,7899045,7904558,7910074,7915591,7921110,7926631,7932154,7937679,7943205,7948734,7954264,7959796,7965330,7970866,7976404,7981944,7987485,7993029,7998574,8004121,8009670,8015221,8020774,8026329,8031885,8037444,8043004,8048566,8054131,8059697,8065264,8070834,8076406,8081979,8087555,8093132,8098711,8104292,8109875,8115460,8121047,8126636,8132226,8137819,8143413,8149009,8154607,8160207,8165809,8171413,8177019,8182626,8188236,8193847,8199461,8205076,8210693,8216312,8221933,8227556,8233180,8238807,8244435,8250066,8255698,8261332,8266968,8272607,8278246,8283888,8289532,8295178,8300825,8306475,8312126,8317780,8323435,8329092,8334751,8340412,8346075,8351740,8357407,8363075,8368746,8374418,8380093,8385769};

static int log2_float_floor( float f ) {
	assert( f > 0. );
	assert( sizeof(f) == sizeof(int) );
	assert( sizeof(f) == 4 );
	return (((*(int *)&f)&0x7f800000)>>23)-0x7f;
}

static float log2_float_approx( float f ) {
	int i;
	assert( f > 0. );
	assert( sizeof(f) == sizeof(int) );
	assert( sizeof(f) == 4 );
	i = (*(int *)&f);
	return (((i&0x7f800000)>>23)-0x7f)+(i&0x007fffff)/(float)0x800000;
}

/**
 * Initialize powFast lookup table.
 *
 * @pTable     length must be 2 ^ precision
 * @precision  number of mantissa bits used, >= 0 and <= 18
 */
static void pow_fast_float_setup_table
(
   unsigned int* const pTable,
   const unsigned int  precision
)
{
   /* step along table elements and x-axis positions */
   float zeroToOne = 1.0f / ((float)(1 << precision) * 2.0f);
   int   i;
   for( i = 0;  i < (1 << precision);  ++i )
   {
      /* make y-axis value for table element */
      const float f = ((float)pow( 2.0f, zeroToOne ) - 1.0f) * _2p23;
      pTable[i] = (unsigned int)( f < _2p23 ? f : (_2p23 - 1.0f) );

      zeroToOne += 1.0f / (float)(1 << precision);
   }                                                                    /* D */
}


/**
 * Get pow (fast!).
 * for pow( 2, val), ilog2 = 1 / log2(2) = 1
 * for pow( e, val), ilog2 = 1 / log(2) = 1.44269504088896
 * for pow(10, val), ilog2 = 1 / log10(2) = 3.32192809488736
 * for pow( r, val), ilog2 = log(r) / log(2) = log(r) * 1.44269504088896
 *
 * @val        power to raise radix to
 * @ilog2      one over log, to required radix, of two
 * @pTable     length must be 2 ^ precision
 * @precision  number of mantissa bits used, >= 0 and <= 18
 */
static float pow_fast_float_lookup
(
   const float         val,
   const float         ilog2,
   unsigned int* const pTable,
   const unsigned int  precision
)
{
   /* build float bits */
   const int i = (int)( (val * (_2p23 * ilog2)) + (127.0f * _2p23) );

   /* replace mantissa with lookup */
   const int it = (i & 0xFF800000) | pTable[(i & 0x7FFFFF) >>           /* E */
      (23 - precision)];                                                /* F */

   /* convert bits to float */
   return *(const float*)( &it );
}

static float exp_fast_float_lookup
(
   const float         val,
   unsigned int* const pTable,
   const unsigned int  precision
)
{
   /* build float bits */
   const int i = (int)( (val * (_2p23 * 1.44269504088896f)) + (127.0f * _2p23) );

   /* replace mantissa with lookup */
   const int it = (i & 0xFF800000) | pTable[(i & 0x7FFFFF) >>           /* E */
      (23 - precision)];                                                /* F */

   /* convert bits to float */
   return *(const float*)( &it );
}
/***************Math tricks part ends************************************/


int ImageEnhancement::ime_alloc_global_buf(int w, int h){
    m_lum_plane = (unsigned char*) malloc(w*h*sizeof(unsigned char));
    if(!m_lum_plane){
        printf("Out of memory.\n");
        return -1;
    }

    m_max_plane = (unsigned char*) malloc(w*h*sizeof(unsigned char));
    if(!m_max_plane){
        printf("Out of memory.\n");
        return -1;
    }

    m_integral_plane = (int*) malloc(w*h*sizeof(int));
    if(!m_integral_plane){
        printf("Out of memory.\n");
        return -1;
    }

    m_param_plane = (int*) malloc(w*h*sizeof(int));
    if(!m_param_plane){
        printf("Out of memory.\n");
        return -1;
    }
    return 0;
}

void ImageEnhancement::ime_free_global_buf(){
    if(m_lum_plane){
        free(m_lum_plane);
        m_lum_plane = 0;
    }
    if(m_max_plane){
        free(m_max_plane);
        m_max_plane = 0;
    }
    if(m_integral_plane){
        free(m_integral_plane);
        m_integral_plane = 0;
    }
    if(m_param_plane){
        free(m_param_plane);
        m_param_plane = 0;
    }
}

int ImageEnhancement::_ime_calc_lum_max(int* rgb_data, int rgb_stride,
                       unsigned char* lum_plane,
                       unsigned char* max_plane,
                       int w, int h)
{
    int x, y;
    int r, g, b;
    unsigned char *rgb_ptr, *gray_ptr, *max_ptr;

    assert(rgb_data);
    assert(lum_plane);
    assert(max_plane);

    for(y = 0; y < h; ++y){
        rgb_ptr = (unsigned char*) rgb_data + y*rgb_stride;
        gray_ptr = lum_plane + y*w;
        max_ptr = max_plane + y*w;
        for(x = 0; x < w; ++x){
            r = *rgb_ptr++;
            g = *rgb_ptr++;
            b = *rgb_ptr++;
            *gray_ptr++ = (unsigned char) ((r+g+b)/3);
            *max_ptr++ = max(r, max(g, b));
        }
    }
    return 0;
}

int ImageEnhancement::_ime_calc_integral_plane(unsigned char* lum_plane, int* integral_plane, int w, int h)
{
    int rs;
    int x, y;

    assert(lum_plane);
    assert(integral_plane);

    rs = 0;
    for(x = 0; x < w; ++x){
        rs += *lum_plane++;
        *integral_plane++ = rs;
    }

    for(y = 1; y < h; ++y){
        rs = 0;
        for(x = 0; x < w; ++x){
            rs += *lum_plane++;
            *integral_plane = rs + *(integral_plane - w);
            ++integral_plane;
        }
    }
    return 0;
}

int ImageEnhancement::_ime_calc_rect_sum(int* integral_plane, int w, int h, int top, int left, int rows, int cols)
{
    int bottom = top + rows - 1;
    int right = left + cols - 1;
    int* bottom_row_ptr = integral_plane + bottom*w;
    int* top_row_ptr = integral_plane + top*w;

    return *(bottom_row_ptr + right) -
        *(bottom_row_ptr + left) -
        *(top_row_ptr + right) +
        *(top_row_ptr +left);
}

int ImageEnhancement::_ime_calc_param(unsigned char* lum_plane, int* integral, int* param, int w, int h)
{
    int x, y, s;
    int l, r, t, b, pix_num;
    int cur_pix, cur_mean, scale_mean[SCALE_NUM];
    int cur_contrast;    
    int idx;

    assert(lum_plane);
    assert(integral);
    assert(param);

    for(y = 0; y < h; ++y){
        for(x = 0; x < w; ++x){
            cur_pix = *lum_plane++;
            cur_mean = 0;
            cur_contrast = 0;
            for(s = 0; s < SCALE_NUM; ++s){
                l = max(0, x-gs_scale_radius[s]);
                r = min(w-1, x+gs_scale_radius[s]);
                t = max(0, y-gs_scale_radius[s]);
                b = min(h-1, y+gs_scale_radius[s]);
                pix_num = (b-t+1)*(r-l+1);

                scale_mean[s] = _ime_calc_rect_sum(integral, w, h, t, l, b-t+1, r-l+1)/pix_num;
                cur_mean += scale_mean[s]/gs_scale_weight_inverse[s];
#ifdef USE_FAST_LOG_APPROXI
                idx = ( (cur_pix+1)<<10 )/(scale_mean[s]+1);
                if(idx > 0 && idx < 2048){//95%命中率，说明绝大部分像素的对比度都落在-4与4之间。
                    /*approx_log10_int[i] = (int)(log10((i+1)/1024.f)*1024);*/
                    cur_contrast += approx_log10_int[idx];
                }else{
                    //cur_contrast += scale_weight[s]*(log2_float_approx((cur_pix+1.f)/(scale_mean[s]+1.f)) * 0.301029996f/*log10(2)*/);
                    //(1/3) * 0.301029996f/*log10(2)*/ = 0.10343331888f
                    cur_contrast += (int)( 1024.f*0.301029996f*log2_float_approx((cur_pix+1.f)/(scale_mean[s]+1.f)) );
                }

#else
                cur_contrast += (int) (g_scale_weight[s]*(log10f((cur_pix+1.f)/(scale_mean[s]+1.f))) * 1024.f);
#endif
            }
#ifdef USE_FAST_LOG_APPROXI
            if(cur_contrast < 0){//当对比度小于0时，手动进一步加大“负”对比度
                cur_contrast = 2*cur_contrast;
            }            
            //Q:Why divide cur_contrast by 4?
            //A: To reduce the contrast stretch. If divide cur_contrast by 3, we'll get a large contrast stretch.
            *param++ = cur_contrast/4 + ( ( (1<<20) - 6627*cur_mean )>>10 );
#else
            if(cur_contrast < 0){//当对比度小于0时，手动进一步加大“负”对比度
                cur_contrast = 2*cur_contrast;
            }
            //(1/3) * 0.301029996f/*log10(2)*/ = 0.10343331888f
            //0.0063203125f = 1.618/256;
            //*param++ = 0.333333333f*cur_contrast+(1.0f-0.0063203125f*cur_mean);
            *param++ = (int)(cur_contrast+(1.0f-0.0063203125f*cur_mean)*1024.f);
#endif
        }
    }

    return 0;
}

int ImageEnhancement::ime_enhance_sub_rect(int* src_rgb, int src_stride,
                          int* dst_rgb, int dst_stride,
                          int w, int h,
                          int sx, int ex,
                          int sy, int ey,
                          float strength)
{
    int x, y, idx;
    int max_val, coef;
    unsigned char *src_ptr, *dst_ptr;
    int strength_int;
    strength_int = (int)(strength*(1<<5));
	int *param_plane = m_param_plane;
	unsigned char *max_plane = m_max_plane;
    assert(src_rgb);
    assert(dst_rgb);
    assert(m_max_plane);
    assert(m_param_plane);

    for(y = sy; y < ey; ++y){
        src_ptr = (unsigned char*) src_rgb + y*src_stride;
        dst_ptr = (unsigned char*) dst_rgb + y*dst_stride;
        for(x = sx; x < ex; ++x){
#if (defined(USE_FAST_POW_APPROXI))
            max_val = *m_max_plane++;
            if(max_val != 0){
                coef = lrintf( exp_fast_float_lookup(-strength * (*m_param_plane++), pow_table_11, 11) * (1<<10) );				
                coef = (1<<28)/( (max_val<<10)+(256-max_val)* coef );
            }else{
                ++m_param_plane;
                coef = 0;
            }
#elif (defined(USE_EXP_LOOKUP_TABLE)) 
            max_val = *max_plane++;
            if(max_val != 0){
                /*strength_int = (int)(strength * (1<<5));*/
                /*appox_exp_int is ranged from -4 to 4, and quantified with 1/128.*/
                idx = (-((strength_int*(*param_plane++))>>8)+4*128);
                idx = idx < 0 ? 0: idx;
                idx = idx >= 2*4*128 ? 2*4*128-1: idx;
                /*appox_exp_int[i] = expf((i-4*128)/128.f) * (1<<10); range: [-4, 4) */
                coef = (1<<30)/( (max_val<<10)+(256-max_val)* approx_exp[idx] );
            }else{
                ++param_plane;
                coef = 0;
            }	
#else
            coef = max_scale/( 1.f+(max_scale-1.f)*expf( -strength * (*m_param_plane++)) );
#endif
            *dst_ptr++ = (unsigned char) ( ((int)(*src_ptr++) * coef)>>12 );
            *dst_ptr++ = (unsigned char) ( ((int)(*src_ptr++) * coef)>>12 );
            *dst_ptr++ = (unsigned char) ( ((int)(*src_ptr++) * coef)>>12 );
        }
    }
    return 0;
}

int ImageEnhancement::ime_preprocess(int* rgb_data, int stride, int w, int h)
{
    gs_scale_radius[0] = (int) (min(w, h)*0.035f);
    gs_scale_radius[1] = 4*gs_scale_radius[0];
    gs_scale_radius[2] = 4*gs_scale_radius[1];

    _ime_calc_lum_max(rgb_data, stride, m_lum_plane, m_max_plane, w, h);
    _ime_calc_integral_plane(m_lum_plane, m_integral_plane, w, h);
    _ime_calc_param(m_lum_plane, m_integral_plane, m_param_plane, w, h);
    return 0;
}

int ImageEnhancement::Enhance(int* src_rgb, int src_stride,
                int* dst_rgb, int dst_stride,
                int width, int height,
                float strength)
{
	ime_preprocess(src_rgb, src_stride, width, height);
	return ime_enhance_sub_rect(src_rgb, src_stride, dst_rgb, dst_stride, width, height, 0, width, 0, height, strength);
}
